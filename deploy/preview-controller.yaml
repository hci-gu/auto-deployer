apiVersion: v1
kind: Namespace
metadata:
  name: preview-controller
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: preview-controller
  namespace: preview-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: preview-controller
rules:
  - apiGroups: [""]
    resources: ["services", "namespaces"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["route.openshift.io"]
    resources: ["routes"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: preview-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: preview-controller
subjects:
  - kind: ServiceAccount
    name: preview-controller
    namespace: preview-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: preview-controller
  namespace: preview-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: preview-controller
  template:
    metadata:
      labels:
        app: preview-controller
    spec:
      serviceAccountName: preview-controller
      containers:
        - name: preview-controller
          image: your-registry/preview-controller:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: LISTEN_ADDR
              value: ":8080"
            - name: GITHUB_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  name: preview-controller-secrets
                  key: githubWebhookSecret
            - name: GITHUB_ALLOWED_REPOS
              value: "org1/repoA"
            - name: PREVIEW_NAMESPACE_MODE
              value: "single"
            - name: PREVIEW_BASE_NAMESPACE
              value: "previews"
            - name: ROUTE_DOMAIN_TEMPLATE
              value: "{app}-pr-{pr}.apps.internal.example.com"
            - name: IMAGE_REF_TEMPLATE
              value: "registry.local/{app}:{tag}"
            - name: IMAGE_TAG_STRATEGY
              value: "pr-sha"
            - name: APP_MAPPING_FILE
              value: "/config/app-mapping.json"
            - name: DEFAULT_CONTAINER_PORT
              value: "8080"
          volumeMounts:
            - name: app-mapping
              mountPath: /config
              readOnly: true
          ports:
            - containerPort: 8080
      volumes:
        - name: app-mapping
          configMap:
            name: preview-controller-config
---
apiVersion: v1
kind: Service
metadata:
  name: preview-controller
  namespace: preview-controller
spec:
  selector:
    app: preview-controller
  ports:
    - name: http
      port: 80
      targetPort: 8080
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: preview-controller
  namespace: preview-controller
spec:
  to:
    kind: Service
    name: preview-controller
  port:
    targetPort: http
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: preview-controller-cleanup
  namespace: preview-controller
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: preview-controller
          restartPolicy: Never
          containers:
            - name: cleanup
              image: your-registry/preview-controller:latest
              imagePullPolicy: IfNotPresent
              env:
                - name: RUN_MODE
                  value: "cleanup"
                - name: STALE_MAX_AGE
                  value: "168h"
                - name: PREVIEW_NAMESPACE_MODE
                  value: "single"
                - name: PREVIEW_BASE_NAMESPACE
                  value: "previews"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: preview-controller-config
  namespace: preview-controller
data:
  app-mapping.json: |
    {
      "org1/repoA": {
        "appName": "myapp",
        "containerPort": 8080,
        "routePath": "",
        "env": {
          "EXAMPLE": "value"
        }
      }
    }
